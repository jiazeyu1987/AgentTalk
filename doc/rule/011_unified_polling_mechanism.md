# 统一的轮询工作方式

**原则ID**: PR-011
**来源文档**: agent_event_handling_mechanism.md
**类别**: 核心机制

---

## 原则描述

所有Agent都通过轮询机制工作。心跳引擎定期扫描inbox，发现执行命令文件后进行处理。

## 轮询工作流程

1. Agent定期扫描自己的inbox/
2. 发现新的命令消息文件 `cmd_*.msg.json`（envelope `type=command`）
3. 检查命令的输入是否满足
4. 如果输入满足，执行命令；如果输入不满足且配置了等待，则等待输入
5. 处理完成后继续下一轮轮询

## 心跳引擎

**负责组件**: 心跳引擎（HeartbeatEngine）

**默认配置**:
- 扫描间隔：每10秒扫描一次inbox/
- 可通过agent_profile.json配置

**支持功能**:
- 多个plan的并发处理
- 空闲时可以进入休眠，减少资源消耗
- 被唤醒信号立即激活
- 自动检查等待中的命令是否满足执行条件

## 扫描优化（推荐）

在保持“只用文件传递”的前提下，轮询性能主要取决于目录扫描成本。推荐：

1. **分目录/前缀过滤**：优先扫描 `cmd_*.msg.json` / `*.msg.json` 等有限集合，避免全量读取大文件。
2. **索引文件（可选）**：系统路由程序可为每个 `inbox/<plan_id>/` 维护一个追加写的 `index.jsonl`（记录新到文件名、message_id、类型、到达时间）；Agent优先读索引再按需读文件。
3. **原子写入配合**：只处理非`.tmp`文件或存在`.done`标记的文件，避免读到半写入内容（见PR-001）。

## 轮询间隔

**默认值**: 10秒

**动态调整**:
- 繁忙时：缩短间隔（如5秒）
- 正常时：默认间隔（如10秒）
- 空闲时：延长间隔（如30秒）

## 关键要点

- **统一性**: 所有Agent使用同一套轮询机制
- **简单性**: 只需扫描和处理执行命令
- **可靠性**: 心跳引擎稳定运行
- **可控性**: 通过配置控制扫描间隔
- **资源优化**: 支持休眠和动态调整
- **自动触发**: 当等待中的输入文件到达时，自动触发命令执行

## 与休眠机制配合

- **运行中**: 正常轮询，处理事件
- **空闲**: 降低轮询频率，节省资源
- **休眠**: 停止轮询，仅监听唤醒信号
- **唤醒**: 收到唤醒信号后立即恢复轮询

---

**最后更新**: 2025-01-08
