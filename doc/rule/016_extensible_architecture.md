# 可扩展的事件处理架构

**原则ID**: PR-016
**来源文档**: agent_event_handling_mechanism.md
**类别**: 架构设计

---

## 原则描述

所有命令都通过同一个轮询机制处理，简化架构。通过prompt定义不同的命令行为，无需修改核心轮询逻辑。

## 架构特点

### 1. 统一处理

- 所有命令都通过同一个轮询机制处理
- 单一的事件扫描循环
- 统一的执行命令处理流程
- 一致的命令处理流程

### 2. 简单可靠

- 无需维护多个事件通道
- 无需复杂的异步回调
- 易于调试和监控
- 故障点少，可靠性高

### 3. 易于扩展

新增命令行为的步骤：

1. 在命令的 `prompt` 字段中定义新的任务描述
2. 如果需要评分，在 `score_criteria` 中定义评分标准
3. 如果需要条件分支，在 `on_complete` 中定义发送目标
4. 无需修改任何代码或核心轮询逻辑

**示例**: 通过prompt实现不同的命令行为

```json
// 命令1: 共识检查
{
  "prompt": "检查所有评分是否达成共识",
  "score_required": true,
  "score_criteria": "共识度0-100分"
}

// 命令2: 质量评估
{
  "prompt": "评估代码质量，检查bug和性能问题",
  "score_required": true,
  "score_criteria": "质量评分0-100分"
}

// 命令3: 简单汇总
{
  "prompt": "汇总所有报告成一份简洁的总结",
  "score_required": false
}
```

### 4. LLM驱动的灵活性

**关键设计思想**: 通过prompt定义命令行为，而非硬编码逻辑。

**优势**:
- **无需修改代码**: 新的命令行为只需修改prompt
- **充分利用LLM**: LLM理解prompt并执行复杂任务
- **高度灵活**: 同一个命令格式可以实现不同的行为
- **易于扩展**: 新增功能不需要新增命令类型或处理器

## 扩展方式

### 新增命令行为

只需修改命令文件的prompt字段，无需修改代码:

1. 在 `prompt` 中描述新的任务
2. 如果需要评分，设置 `score_required=true` 并定义 `score_criteria`
3. 在 `on_complete` 中定义结果发送目标
4. 完成新的命令行为定义

**示例**: 从简单汇总升级为深度分析

**简单版本**:
```json
{
  "prompt": "汇总所有反馈",
  "score_required": false
}
```

**深度分析版本**:
```json
{
  "prompt": "分析所有反馈，识别主要问题、次要问题和建议，按优先级排序",
  "score_required": true,
  "score_criteria": "根据分析质量评分0-100分"
}
```

### 新增评分标准

只需在prompt中定义新的评分标准:

```json
{
  "prompt": "评估代码安全性，检查SQL注入、XSS、CSRF等漏洞",
  "score_criteria": "根据安全漏洞数量和严重程度评分0-100分"
}
```

### 新增条件分支

只需在 `on_complete` 中定义不同的发送目标:

```json
{
  "on_complete": {
    "send_to_condition": [
      {"min_score": 80, "send_to": ["agent_approver"]},
      {"min_score": 0, "send_to": ["agent_reviewer"]}
    ]
  }
}
```

## 关键要点

- **开闭原则**: 对扩展开放（通过prompt），对修改关闭（核心逻辑）
- **LLM驱动**: 所有命令行为通过prompt定义，充分利用LLM能力
- **零代码扩展**: 新增功能无需修改代码，只需修改prompt
- **可测试**: 新的prompt可以独立测试
- **向后兼容**: 新增功能不影响现有功能
- **统一格式**: 所有命令使用相同的JSON格式

---

**最后更新**: 2025-01-08
