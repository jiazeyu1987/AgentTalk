# Agent能力自评机制

**原则ID**: PR-021
**来源文档**: agent_capability_self_assessment.md
**类别**: 核心机制

---

## 原则描述

Agent接收到命令后，根据自己的提示词分析任务与自身能力的匹配度，并给出评分和原因。如果评分过低，由规划者/监控系统触发重规划或人工介入；在“规划者退出运行期”的模式下，推荐在任务文件中预先定义fallback或失败处理策略。

## 核心思想

**自适应任务分配**:
- Agent接收命令后不自接执行，先评估
- 评分高（≥70分）：执行任务
- 评分低（<70分）：拒绝执行，说明原因
- 规划者/监控系统收到低分后重规划、走fallback，或请求人工介入

## 自评流程

### 1. 接收命令

Agent 从 inbox 收到命令消息 `cmd_*.msg.json`（envelope `type=command`）。

### 2. 读取自身提示词

Agent读取自己的agent_profile.json，获取：
- Agent的能力描述
- 擅长的技能
- 不擅长的领域
- 约束条件

### 3. 分析命令

Agent分析命令的：
- prompt字段：任务描述
- required_inputs：需要的输入
- 预期的输出类型

### 4. 能力匹配评估

Agent根据自己的提示词，评估：
1. 任务是否在自己的技能范围内？
2. 输入是否是自己能处理的类型？
3. 输出是否是自己能产生的类型？
4. 任务复杂度是否在自己的能力范围内？
5. 是否有其他约束条件不满足？

### 5. 生成评分和原因

Agent生成0-100分的评分，并说明原因。

**评分标准**:
- **90-100分**: 完全匹配，Agent非常擅长此类任务
- **70-89分**: 匹配，Agent可以完成此任务
- **50-69分**: 部分匹配，Agent有些能力不足
- **0-49分**: 不匹配，Agent无法完成此任务

**评分示例**:

**高分示例（85分）**:
```json
{
  "score": 85,
  "decision": "ACCEPT",
  "reason": "任务在我的技能范围内。我擅长需求分析和用户故事编写，要求的输入是需求文档，输出是用户故事，完全符合我的能力。"
}
```

**低分示例（30分）**:
```json
{
  "score": 30,
  "decision": "REJECT",
  "reason": "任务不在我的技能范围内。命令要求'编写Python代码实现API'，但我是产品经理Agent，不擅长编码。我的技能是需求分析、产品设计、用户故事编写，不包含代码编写。"
}
```

**中分示例（60分）**:
```json
{
  "score": 60,
  "decision": "ACCEPT_WITH_RESERVATION",
  "reason": "任务部分匹配。命令要求'编写API文档和使用手册'，我擅长编写用户手册，但不熟悉API文档。建议将任务拆分为两部分：API文档由技术Agent编写，使用手册由我编写。"
}
```

### 6. 返回自评结果

Agent将自评结果发送给上层Agent。

**自评结果格式**:
```json
{
  "agent_id": "agent_product_manager",
  "command_id": "cmd_task_001",
  "plan_id": "plan_develop_ecommerce",
  "task_id": "task_001",
  "command_seq": 1,
  "score": 85,
  "decision": "ACCEPT",
  "reason": "任务在我的技能范围内...",
  "timestamp": "2025-01-08T10:30:00Z"
}
```

### 7. 上层Agent处理

**如果评分≥70分**:
- 上层Agent确认分配
- Agent开始执行任务

**如果评分<70分**:
- 上层Agent收到拒绝
- 上层Agent根据reason重新评估
- 上层Agent重新分配给其他Agent

> 在“规划者退出运行期”的模式下，上述“上层Agent”可由系统监控程序+人工介入替代；更推荐在任务文件中预先定义候选执行者或失败分支，避免运行期临时重规划。

## 决策类型

### ACCEPT

接受任务。

**条件**: 评分≥70分

**行为**: Agent开始执行任务

### REJECT

拒绝任务。

**条件**: 评分<50分

**行为**: Agent不执行，上层Agent重新分配

### ACCEPT_WITH_RESERVATION

有保留地接受任务。

**条件**: 评分50-69分

**行为**:
- Agent可以执行，但建议调整任务
- 上层Agent可以选择：
  - 重新分配
  - 调整任务后重新发送
  - 让Agent尝试执行

## 提示词设计

Agent的agent_profile.json中包含自评提示词：

```json
{
  "agent_id": "agent_product_manager",
  "self_assessment_prompt": "你是产品经理Agent，擅长需求分析、产品设计、用户故事编写、验收标准定义。你不擅长代码编写、系统架构设计、数据库设计。

收到命令后，请评估：
1. 任务是否在你的技能范围内？
2. 输入是否是你能处理的类型？
3. 输出是否是你能产生的类型？
4. 任务复杂度是否在你的能力范围内？

给出0-100分的评分，并详细说明原因。"
}
```

## 关键要点

- **先评后执行**: 接收命令后先评估，不盲目执行
- **量化评分**: 0-100分的量化评分
- **详细原因**: 必须说明评分的理由
- **自适应分配**: 低分触发重新分配
- **避免浪费**: 不匹配的任务不会被执行
- **提高效率**: 任务分配给最合适的Agent

## 与其他原则的配合

### 与PR-009（任务分配机制）配合

- GM根据visibility_list分配任务
- Agent自评验证分配是否合理
- 自评低分触发GM重新分配

### 与PR-018（visibility_list文件格式）配合

- visibility_list声明Agent的能力
- Agent根据声明的能力进行自评
- 自评验证任务是否匹配声明的能力

### 与PR-007（统一的执行命令）配合

- 命令包含prompt和required_inputs
- Agent分析命令内容进行自评
- 自评结果影响命令的执行

### 与PR-017（日志追踪）配合

- 记录每次自评的结果
- 记录重新分配的历史
- 分析分配效率和准确性

---

**最后更新**: 2025-01-08
